<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZF2R23JS4K"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-ZF2R23JS4K');
</script>

  <style> body { margin: 0; } </style>

  <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico">
  <script src="//unpkg.com/force-graph"></script>
  <script src="//unpkg.com/d3-quadtree"></script>
  <script src="//unpkg.com/d3-force"></script>
  <script src="//unpkg.com/d3-bboxCollide"></script>
  <script src="libraries/rainbowvis.js"></script>
  <script src="js/hgnc_dict.js"></script>
  <script src="js/recordScript.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/underscore@1.13.3/underscore-umd-min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweakpane@3.0.2/dist/tweakpane.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@tweakpane/plugin-essentials@0.1.5/dist/tweakpane-plugin-essentials.min.js"></script>
  <script src="js/fstdropdown.js"></script>
  <script src="js/reimg.js"></script>
  <script src="//unpkg.com/element-resize-detector/dist/element-resize-detector.min.js"></script>
  <link rel="stylesheet" href="css/fstdropdown-2d.css">
  <link rel="stylesheet" href="css/visualization.css">
  <style type="text/css">

    @font-face {
      font-family: "MyriadPro-Regular";
      src: url("fonts/MYRIADPROREGULAR.woff") format("woff");
    }
    
    @font-face {
    font-family: "Century Gothic";
    src: url("fonts/CenturyGothic.woff") format("woff");
    }
    
    @font-face {
    font-family: "CenturyGothicPro";
    src: url("fonts/CenturyGothic.woff") format("woff");
    }
    
    @font-face {
    font-family: "CenturyGothicPro-Bold";
    src: url("fonts/CenturyGothic-Bold.woff") format("woff");
    }
  
    @font-face {
      font-family: "helveticaBold";
      src: url("fonts/helvetica-bold-webfont.woff") format("woff");
      }
  
  </style>
</head>

<body>
  <div id="graph"></div>
<div>

<div>
    <svg version="1.1" id="Layer_1" onclick="window.location.href = 'index.html'" xmlns="http://www.w3.org/2000/svg" width = "150px" style="top:2%;left:1%;position:absolute;cursor: pointer;z-index:10;" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 710.3 222.4" xml:space="preserve"> <style type="text/css"> .st0b{fill:#424A60;} .st1b{fill:#DC298D;} .st2b{fill:#7383BF;} .st3b{fill:#969696;} .st4b{fill:#EBBA16;} .st5b{fill:#06ABEB;} .st6b{font-family:'helveticaBold';} .st7b{font-size:84.3397px;} .st8b{letter-spacing:-1;} </style> <g id="Layer_1_00000056390415183483724190000009750584087129516189_"> <g id="path5"> <rect x="92.8" y="154.2" transform="matrix(0.3589 -0.9334 0.9334 0.3589 -62.6169 220.6174)" class="st0b" width="72.9" height="3.3"/> </g> <rect id="path4" x="156.9" y="60.1" transform="matrix(0.8102 -0.5861 0.5861 0.8102 0.7614 131.2305)" class="st0b" width="92.3" height="8.7"/> <g id="path3"> <rect x="19" y="127.2" transform="matrix(0.9138 -0.4063 0.4063 0.9138 -46.9835 44.8278)" class="st0b" width="126.2" height="11.8"/> </g> <g id="path2"> <rect x="122.6" y="16.9" transform="matrix(0.9138 -0.4063 0.4063 0.9138 -9.3065 55.4032)" class="st0b" width="6.4" height="65.4"/> </g> <rect id="path1" x="169" y="110.3" transform="matrix(0.9138 -0.4063 0.4063 0.9138 -48.6296 83.9257)" class="st0b" width="8.7" height="92.3"/> <circle id="circle6" class="st1b" cx="249.7" cy="34.5" r="21.8"/> <circle id="circle5" class="st2b" cx="112.1" cy="200.6" r="21.8"/> <circle id="circle4" class="st1b" cx="21.8" cy="156.5" r="21.8"/> <circle id="circle3" class="st3b" cx="109.6" cy="13.1" r="13.1"/> <circle id="circle2" class="st4b" cx="189.6" cy="193.1" r="13.1"/> <circle id="circle1" class="st5b" cx="149.5" cy="102.8" r="37.3"/> </g> <g id="Layer_2_00000013871697503241264390000008040421359665832584_"> <text transform="matrix(1 -3.490651e-03 3.490651e-03 1 243.0089 140.7256)" class="st6b st7b">PhosNet</text> <text transform="matrix(1 -3.490651e-03 3.490651e-03 1 585.1035 139.5315)" class="st6b st7b st8b">V</text> <text transform="matrix(1 -3.490651e-03 3.490651e-03 1 639.8698 139.3403)" class="st6b st7b">is</text> </g> </svg>
</div>
    
<div id="nodequeryMain" style="display: none;">
  <select class='fstdropdown-select' id="nodequery" onchange="updateSearch()" style="margin-top: -100px;">
      <option value="">Node Query</option>
  </select>
</div>

<div id="infoBox" style="display: none;">  
  <div id="infoTop"> 
    <p id="nodeName" style="font-family: CenturyGothicPro-Bold; margin:6px;">Node: <a id = "nodehref" href="https://www.w3schools.com" target="_blank" style="color: #00709d;">placeholder1</a>   <img style = "width: 20px; margin-bottom: 5px;" src="https://www.phosphosite.org/images/header/logo_psp_white_cp.png"/></p>
    <p id = "nodeType" style="font-family: CenturyGothicPro-Bold; margin:6px;">Type: <a id="typetext">placeholder2</a> <a id="activityText">|  Activity: </a> <a id="activityNum">**</a></p>
    <p style="font-family: CenturyGothicPro-Bold; margin:6px;"> <u>Phosphorylation Info</u> <h style="font-family: CenturyGothicPro-Bold; font-size: 12px;">*(scrollable)</h></p>
  </div>
  <table id = "phosTable" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th style="background-color:rgba(240, 240, 240, .8);">Site ID</th>
            <th style="background-color:rgba(240, 240, 240, .8)">log2FC</th>
            <th style="background-color:rgba(240, 240, 240, .8)">pValue</th>
        </tr>
    </thead>
    <tbody id = "tbody">
    </tbody>
</table>
</div>

<div id="guiplace"> </div>


</div>



<script>

/////////////////////////////////////////
////////// DATA CREATION ///////////////
///////////////////////////////////////

function linkExist(sourceTargetTuples,kinaseID,targetID){
  for (let idx = 0; idx < sourceTargetTuples.length; idx++) {
    currTuple = sourceTargetTuples[idx]
    if (currTuple[0] === kinaseID && currTuple[1] === targetID){
      return true
    }
  }
return false
}

function parseCSV(file_name) {
let dict = {"nodes": [], "links": []}

var userData = JSON.parse(window.localStorage.getItem(file_name));
for (let i = 0; i < userData.length; i++) {
  dataLine = userData[i]
  kinaseID =  dataLine['KinaseID']
  kinaseSize = dataLine['KinaseSize']
  kinaseActivity = dataLine['KinaseActivity']
  edgeWeight = dataLine['EdgeWeight']
  edgeColor = dataLine['EdgeColor']
  targetID = dataLine['TargetID']
  targetSize = dataLine['TargetSize']
  diffPhos = dataLine['log2FC']
  PhosphoSiteID = dataLine['PhosphoSiteID']
  pValue = dataLine['pValue']

  currentNodeList = dict["nodes"].map(el => el.id)

  //kinase is type 1, target is type 2
  if (!(currentNodeList.includes(kinaseID))){ // if kinase id does not occur in nodes
    dict["nodes"].push({'id': kinaseID, "type": 1, "kinaseActivity":kinaseActivity, "nodeSize": kinaseSize, "nodeColors": [], "partitionIDs":[], "pValues":[]})
    currentNodeList.push(kinaseID)
  }
  else { // kinase id occurs, need to check if it is labeled as target and change its type into kinase (1)
    nodeIndex = currentNodeList.indexOf(kinaseID)
    dict['nodes'][nodeIndex]['type'] = 1
  }

  if (!(currentNodeList.includes(targetID))){
    let currentNodeColors = []
    if(diffPhos!=undefined){currentNodeColors.push(diffPhos)}
    let currentNodePartitions = []
    if(PhosphoSiteID!=undefined){currentNodePartitions.push(PhosphoSiteID)}
    let currentpValues = []
    if(pValue!=undefined){currentpValues.push(pValue)}
    dict["nodes"].push({'id': targetID, "type": 2, "kinaseActivity":0, "nodeSize": targetSize, "nodeColors": currentNodeColors, "partitionIDs": currentNodePartitions, "pValues": currentpValues})
  }

  else{ // target id occurs again (must need partitions!!!), need to append diffPhos to nodecolors and PhosphoSiteID to partitionIDs
        // no need to update its type as target !!!!!!!!
      nonDirtyNodeList = dict["nodes"].map(el => el.id)
      nodeIndex = nonDirtyNodeList.indexOf(targetID)
      if(PhosphoSiteID != undefined && !(dict['nodes'][nodeIndex]['partitionIDs'].includes(PhosphoSiteID))){
        dict['nodes'][nodeIndex]['partitionIDs'].push(PhosphoSiteID)
        if(diffPhos!=undefined){dict['nodes'][nodeIndex]['nodeColors'].push(diffPhos)}
        if(pValue!=undefined){ dict['nodes'][nodeIndex]['pValues'].push(pValue)}
      }
  }

  sourceTargetTuples = dict["links"].map(el => [el.source,el.target])

  if(!(linkExist(sourceTargetTuples,kinaseID,targetID))){
    if(kinaseID===targetID){
      dict['links'].push({'source': kinaseID, 'target': targetID, 'edgeWeight': edgeWeight, 'edgeColor': edgeColor, 'curvature':.4})
    }
    else{
      dict['links'].push({'source': kinaseID, 'target': targetID, 'edgeWeight': edgeWeight, 'edgeColor': edgeColor, 'curvature':0})
    }
  }
}


for(let nodeIndex = 0 ; nodeIndex<dict['nodes'].length; nodeIndex++){

 
    let tempColors = dict['nodes'][nodeIndex]['nodeColors']
    
    indices = Array.from(tempColors.keys()).sort( (a,b) => tempColors[b]-tempColors[a])
        
    dict['nodes'][nodeIndex]['partitionIDs'] = indices.map(i => dict['nodes'][nodeIndex]['partitionIDs'][i])
    dict['nodes'][nodeIndex]['nodeColors'] = indices.map(i => dict['nodes'][nodeIndex]['nodeColors'][i])
    dict['nodes'][nodeIndex]['pValues'] = indices.map(i => dict['nodes'][nodeIndex]['pValues'][i])

    if(dict['nodes'][nodeIndex]['nodeColors'].length>10){
    dict['nodes'][nodeIndex]['partitionIDs'] = [...dict['nodes'][nodeIndex]['partitionIDs'].slice(0,5), ...dict['nodes'][nodeIndex]['partitionIDs'].slice(-5)]
    dict['nodes'][nodeIndex]['nodeColors'] = [...dict['nodes'][nodeIndex]['nodeColors'].slice(0,5), ...dict['nodes'][nodeIndex]['nodeColors'].slice(-5)]
    dict['nodes'][nodeIndex]['pValues'] = [...dict['nodes'][nodeIndex]['pValues'].slice(0,5), ...dict['nodes'][nodeIndex]['pValues'].slice(-5)]
  }

}

dict['ids'] = dict["nodes"].map(el => el.id)

return dict;
}

var file_names = JSON.parse(localStorage.getItem("file_names"))
var index = localStorage.getItem("idx")
var finalDataObj = parseCSV(localStorage.getItem(file_names[index]))

function thresholdDecider(DataObj){ // may consider adding rectangleCollide = d3.bboxCollide here

let nodeSizes = (DataObj["nodes"].map(el => el.nodeSize)).filter(x => x != undefined)
let nodeColors = ((DataObj["nodes"].map(el => el.nodeColors)).flat()).filter(x => x != undefined)
let nodeSizeRange = [Math.min.apply(Math, nodeSizes), Math.max.apply(Math, nodeSizes)]
let nodeColorRange = [Math.min.apply(Math, nodeColors), Math.max.apply(Math, nodeColors)]
let nodeColorThreshold = null

if (nodeColorRange[0] != undefined && nodeColorRange[1] != undefined){
  let minPositive = 0
  let maxPositive = 0
  nodeColorRange[0]<0 ? minPositive = - nodeColorRange[0] : minPositive = nodeColorRange[0]
  nodeColorRange[1]<0 ? maxPositive = - nodeColorRange[1] : maxPositive = nodeColorRange[1]
  minPositive>maxPositive  ? nodeColorThreshold = minPositive : nodeColorThreshold = maxPositive
}

let edgeWeights = (DataObj["links"].map(el => el.edgeWeight)).filter(x => x != undefined)
let edgeColors = (DataObj["links"].map(el => el.edgeColor)).filter(x => x != undefined)
let edgeWeightRange = [Math.min.apply(Math, edgeWeights), Math.max.apply(Math, edgeWeights)]
let edgeColorRange = [Math.min.apply(Math, edgeColors), Math.max.apply(Math, edgeColors)]

return {"nodeSizes":nodeSizes, "nodeColors":nodeColors, "nodeSizeRange":nodeSizeRange, "nodeColorRange":nodeColorRange, "nodeColorThreshold":nodeColorThreshold, "edgeWeights":edgeWeights, "edgeColors":edgeColors, "edgeWeightRange":edgeWeightRange, "edgeColorRange":edgeColorRange}

}


/////////////////////////////////////////
////////// GRAPH CREATION //////////////
///////////////////////////////////////

var thresholds = thresholdDecider(finalDataObj)
var [nodeSizes, nodeColors, nodeSizeRange, nodeColorRange, nodeColorThreshold, edgeWeights, edgeColors, edgeWeightRange, edgeColorRange] = [thresholds["nodeSizes"], thresholds["nodeColors"], thresholds["nodeSizeRange"], thresholds["nodeColorRange"], thresholds["nodeColorThreshold"], thresholds["edgeWeights"],thresholds["edgeColors"],thresholds["edgeWeightRange"],thresholds["edgeColorRange"]]
var nodesList = finalDataObj["ids"]

var rectangleCollide = d3.bboxCollide([[-8,-14],[8,14]])

    const Graph = ForceGraph({rendererConfig:{preserveDrawingBuffer : true}})
      (document.getElementById('graph'))

      .nodeCanvasObject((node, ctx) => {
        var arrayLength = node.nodeColors.length;

        ctx.fillStyle = '#808080';
          ctx.fillRect(node.x - 6, node.y - 2.5, 12, 5);

        if (arrayLength == 0 || arrayLength == undefined){
          ctx.fillStyle = '#808080';
          ctx.fillRect(node.x - 6, node.y - 2.5, 12, 5);
        }
        else{
          const partitionNum = 5
          arrayLength = arrayLength >= partitionNum ? partitionNum : arrayLength;

        for (var i = 0; i < arrayLength; i++) {
            ctx.fillStyle = nodeColoring(node.nodeColors[i]);
            ctx.fillRect(node.x - 6, node.y - 2.5 + i*5, 12, 5);       
          }
        }
        })
        .nodePointerAreaPaint(nodePaint)
        .nodeId('id')
        .nodeLabel('id')
        .graphData(finalDataObj);

        Graph.d3Force('collide', rectangleCollide);
        Graph.d3Force('charge').strength(-70);
        Graph.zoom(1.3)
        // Graph.d3Force('link').distance(link => 70);
  
        elementResizeDetectorMaker().listenTo(
          document.getElementById('graph'),
          el => {
          Graph.width(el.offsetWidth)
          Graph.height(el.offsetHeight)
          }
          );

/////////////////////////////////////////
////////// COLORING ////////////////////
///////////////////////////////////////
        function nodePaint(node, color, ctx) {
          var partition = node.nodeColors.length < 5 ? node.nodeColors.length : 5
          if(partition == 0){ partition = 1}
          ctx.fillStyle = color
          ctx.fillRect(node.x-6, node.y-2.5, 12, 5*partition);
         }

        function normalized(value, actual_bounds, desired_bounds) { 
          return (desired_bounds[0] + (value - actual_bounds[0]) * (desired_bounds[1] - desired_bounds[0]) / (actual_bounds[1] - actual_bounds[0]))
        }

        function nodeColoring (l2fc_value) {
          if(l2fc_value === "kinase"){
            return "#f5aa3b"
          }

            if (nodeColorRange[0] != undefined && nodeColorRange[1] != undefined){
            
            let rainbow = new Rainbow(); 
            nodeColorThreshold > 3 ? rainbow.setNumberRange(-3, 3) : rainbow.setNumberRange(-nodeColorThreshold, nodeColorThreshold)
            
            rainbow.setSpectrum('2600e6', '2A00FF', '5533FF', '7F66FF', 'AA99FF', 'D4CCFF', 'cccccc', 'FFCCDD', 'FF99BB', 'FF6699', 'FF3377', 'FF0055', 'CC0044');
          
            if (l2fc_value === "null") {
              return "#cccccc"
            }
            else{
              let hexColour = rainbow.colourAt(l2fc_value);
              let stringColor = '#' + hexColour
              return stringColor
            }

          }
        }

/////////////////////////////////////////
////////// GUI CONTROLS ////////////////
////////////////////////////////////////
const fnames = {};
 for (const key of file_names) {
  fnames[key] = key;
 }

 const PARAMS = {
  Network: file_names[index],
  PosL2FC : 0,
  NegL2FC : 0,
  Background : "#ffffff",
  Phosphorylation: "Show",
  Labels: "Off"
};

const phosOpt = ["Hide", "Show"];
const labelOpt = ["On", "Off"];

const pane = new Tweakpane.Pane({
  container: document.getElementById('guiplace'),
});

pane.registerPlugin(TweakpaneEssentialsPlugin);

const tab = pane.addTab({
  pages: [{title: 'Controls'}],
});

tab.pages[0].addInput(PARAMS, 'Network', {options: fnames, label: 'Network'}).on('change', (ev) => {
changeState();
});

tab.pages[0].addInput(PARAMS, 'Background').on('change', (ev) => {
updateBackground();
});

tab.pages[0].addButton({title: 'Enter/Exit Fullscreen'}).on('click',()=>{
  fullscreen();
});

tab.pages[0].addButton({title: 'Take a screenshot'}).on('click',()=>{
  snapshot();  
});

tab.pages[0].addSeparator();
tab.pages[0].addSeparator();

tab.pages[0].addButton({title: 'Switch to 3D'}).on('click',()=>{
  window.location.href = 'visualization.html'
});

/////////////////////////////////////////////////
////////////// UPDATE FUNCTIONS /////////////////
/////////////////////////////////////////////////

function updateBackground() {
      Graph
        .backgroundColor(PARAMS.Background)
}

function changeState(){
let new_file_name = PARAMS.Network
localStorage.setItem('idx',file_names.indexOf(new_file_name))
location.reload();
}

function snapshot(){
let canvas = document.getElementsByTagName('canvas')[0];
var ctx = canvas.getContext('2d');
ctx.globalCompositeOperation = 'destination-over';
ctx.fillStyle = PARAMS.Background;
ctx.fillRect(0, 0, canvas.width+10, canvas.height+10);
ctx.fillRect(0, 0, -canvas.width-10, -canvas.height-10);
ctx.fillRect(0, 0, canvas.width+10, -canvas.height-10);
ctx.fillRect(0, 0, -canvas.width-10, canvas.height+10);
ReImg.fromCanvas(document.getElementsByTagName('canvas')[0]).downloadPng();
}


  </script>
</body>